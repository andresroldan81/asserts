---
#
# Archivo de configuracion del servicio de integración continua.
#

# Este parche se requiere para que docker soporte especificación de IPs
machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  timezone: America/Bogota
  services:
    - docker
  python:
    version: 2.7.10
  post:
    - pyenv global 2.7.11 3.4.4 3.5.1

dependencies:
  pre:
    - sudo apt-get update
    - sudo apt-get install software-properties-common
    - sudo apt-add-repository -y ppa:ansible/ansible
    - sudo apt-get update
    - pip install --upgrade pip setuptools
    - docker -D login -u $DOCKER_USER -p $DOCKER_PASS -e $DOCKER_EMAIL
    - echo $VAULT > ~/.vault.txt
  override:
    - sudo apt-get install scons ansible ruby
    - gem install overcommit
    - pip install tox tox-pyenv flake8 pylint yamllint twine
    - docker -D pull fluidsignal/fluidasserts:container
    - scons deps
  post:
    - ansible-vault --vault-password-file ~/.vault.txt decrypt conf/dotpypirc
    - mv conf/dotpypirc ~/.pypirc
    - scons self
    - scons smoke

# Antes de este punto todo es cacheable.  Pendiente investigar como.

test:
  pre:
    - scons lint
    - overcommit --sign
    - overcommit --run
  override:
    - scons test
    - scons dist
    - scons doc
  post:
    - cp build/test/results.* $CIRCLE_TEST_REPORTS
    - cp -r build/coverage $CIRCLE_ARTIFACTS
    - cp -r build/lint $CIRCLE_ARTIFACTS
    - cp -r build/doc $CIRCLE_ARTIFACTS
    - cp -r build/dist $CIRCLE_ARTIFACTS
    - python setup.py sdist bdist_wheel upload
