#
# Archivo de configuracion del servicio de integración continua.
#

machine:
  pre:
# Este parche se requiere para que docker soporte especificación de IPs
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  timezone: America/Bogota
  services:
    - docker
# version de python del sistema base de CI, se requiere por ansible en 2.7
  python:
    version: 2.7.10
  post:
# versiones de python contra los cuales se probara el producto.
# https://circleci.com/docs/build-image-trusty/#python
    - pyenv global 2.7.11 3.4.4 3.5.1

dependencies:
  pre:
    - apt-get update
    - apt-get install scons
    - pip install invoke ansible tox tox-pyenv configobj
    - pip install --upgrade pip setuptools
    - pip install ansible tox tox-pyenv configobj
  override:
# descargar imagen de docker
    - docker login -u $DOCKER_USER -p $DOCKER_PASS -e $DOCKER_EMAIL
    - docker pull fluidsignal/fluidasserts:container
    - scons deps
  post:
    - test/container/start.sh
    - test/container/smoke.sh
    - test/setup/smoke.sh
    - test/container/stop.sh

# Antes de este punto todo es cacheable.  Pendiente investigar como.

test:
  pre:
     - scons lint
  override:
     - scons test
     - scons dist
     - scons doc
  post:
    - cp build/test/results.* $CIRCLE_TEST_REPORTS
    - cp build/results.log $CIRCLE_ARTIFACTS
    - cp -r build/coverage $CIRCLE_ARTIFACTS
    - cp -r build/lint $CIRCLE_ARTIFACTS
    - cp -r build/doc $CIRCLE_ARTIFACTS
    - cp -r dist $CIRCLE_ARTIFACTS
