---
- name: Installs and configure Apache + PHP + MySQL 
  hosts: container
  become: "yes"
  vars:
      servername: localhost
      mysql_root_user: root
      mysql_root_password: password
  tasks:
      - name: Set MySQL root password
        debconf: name=mysql-server
            question=mysql-server/root_password
            value={{ mysql_root_password }}
            vtype=password

      - name: Confirm mysql root password
        debconf: name=mysql-server
            question=mysql-server/root_password_again
            value={{ mysql_root_password }}
            vtype=password

      - name: Install dependencies
        apt: name={{ item }} update_cache=yes cache_valid_time=3600
        with_items:
            - ca-certificates
            - mysql-server
            - python-mysqldb
            - unzip
            - apache2
            - php5
            - php5-mysql
            - php-pear
            - php5-gd
            - libapache2-mod-php5
            - dnsutils

      - name: Start and enable MySQL
        service: name=mysql state=started enabled=yes

      - name: Configure php.ini allow_url_include
        ini_file:
            dest: /etc/php5/apache2/php.ini
            section: PHP
            option: allow_url_include
            value: "On"
        notify: Restart apache2

      - name: Configure php.ini allow_url_fopen
        ini_file:
            dest: /etc/php5/apache2/php.ini
            section: PHP
            option: allow_url_fopen
            value: "On"
        notify: Restart apache2

      - name: Configure Apache parameters hard
        lineinfile:
            dest: /etc/apache2/apache2.conf
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            regexp: '^ServerName'
            line: 'ServerName {{ servername }}'
        with_items:
            - {regexp: "^ServerName", line: "ServerName {{ servername }}"}
            - {regexp: "^ServerTokens", line: "ServerTokens Prod"}
            - {regexp: "^ServerSignature", line: "ServerSignature Off"}
        notify: Restart apache2

  handlers:
      - name: Restart apache2
        service: name=apache2 state=restarted
