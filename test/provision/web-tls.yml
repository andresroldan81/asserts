---
- name: Configure container with nginx and TLS
  hosts: container 
  become: yes 
  vars:
        key_file: /etc/nginx/ssl/nginx.key
        cert_file: /etc/nginx/ssl/nginx.crt
        conf_file: /etc/nginx/sites-available/default
        server_name: localhost
  tasks:
        - name: Install nginx
          apt: name=nginx update_cache=yes cache_valid_time=3600
          tags: basic

        - name: create directories for ssl certificates
          file: path=/etc/nginx/ssl state=directory
          tags: basic

        - name: copy nginx config file
          template: src=nginx/nginx-tls.conf.j2 dest={{ conf_file }}
          notify: restart nginx
          tags: basic

        - name: enable configuration
          file: dest=/etc/nginx/sites-enabled/default src={{ conf_file }} state=link
          notify: restart nginx
          tags: basic

        - name: copy index.html
          template: src=nginx/index.html.j2 dest=/usr/share/nginx/html/index.html
                mode=0644
          tags: basic

        - name: copy TLS key
          copy: src=nginx/nginx-hard.key dest={{ key_file }} owner=root mode=0600
          notify: restart nginx
          tags: basic 

        - name: copy TLS certificate
          copy: src=nginx/nginx-hard.crt dest={{ cert_file }}
          notify: restart nginx
          tags: basic


# tag: weak
# certificado inseguro
#
        - name: copy weak nginx config file
          template: src=nginx/nginx-tls-weak.conf.j2 dest={{ conf_file }}
          notify: restart nginx
          tags: weak 

        - name: copy TLS key
          copy: src=nginx/nginx-weak.key dest={{ key_file }} owner=root mode=0600
          notify: restart nginx
          tags: weak 

        - name: copy TLS certificate
          copy: src=nginx/nginx-weak.crt dest={{ cert_file }}
          notify: restart nginx
          tags: weak 

# tag: hard 
# certificado seguro
        - name: copy weak nginx config file
          template: src=nginx/nginx-tls-hard.conf.j2 dest={{ conf_file }}
          notify: restart nginx
          tags: hard 

        - name: copy TLS key
          copy: src=nginx/nginx-hard.key dest={{ key_file }} owner=root mode=0600
          notify: restart nginx
          tags: hard 

        - name: copy TLS certificate
          copy: src=nginx/nginx-hard.crt dest={{ cert_file }}
          notify: restart nginx
          tags: hard 

  handlers:
        - name: restart nginx
          service: name=nginx state=restarted
