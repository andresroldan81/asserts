---
- name: Configure container with OpenLDAP
  hosts: container
  become: "yes"
  vars:
        server_name: localhost
        openldap_client_uri: ldap://localhost
        openldap_client_base: dc=example,dc=com
        openldap_server_rootdn: cn=Manager,dc=example,dc=com
        openldap_server_password_hash: "{SSHA}"
        openldap_server_rootpw: password
        openldap_server_configuration: /etc/ldap/slapd.conf
        openldap_server_directory: /var/lib/ldap/
        openldap_client_configuration: /etc/ldap/ldap.conf
  tasks:
        - name: Install OpenLDAP
          apt: name=slapd update_cache=yes cache_valid_time=3600
          tags: basic

        - name: Hash OpenLDAP rootpw
          command: slappasswd -h {{ openldap_server_password_hash }} -s {{ openldap_server_rootpw }}
          register: rootpw

        - name: Create OpenLDAP server configuration
          template: >
              src=openldap/slapd.conf.j2
              dest={{ openldap_server_configuration }}
              owner=root
              group=root
              mode=0644
          notify: restart slapd
          tags: basic

        - name: Create OpenLDAP DB_CONFIG
          template: >
               src=openldap/DB_CONFIG
               dest={{ openldap_server_directory }}/DB_CONFIG
               owner=openldap
               group=openldap
               mode=0600
          notify: restart slapd
          tags: basic

        - name: Create OpenLDAP client configuration
          template: >
               src=openldap/ldap.conf.j2
               dest={{ openldap_client_configuration }}
               owner=root
               group=root
               mode=0644
          tags: basic

        - name: Start OpenLDAP
          service: name=slapd state=started enabled=yes
          tags: basic

  handlers:
        - name: restart slapd
          service: name=slapd state=restarted
