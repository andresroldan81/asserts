---
- name: Installs and configure bWAPP for OWASP TOP 10 testing
  hosts: container
  become: "yes"
  vars:
      servername: localhost
      mysql_db: bWAPP
      mysql_root_user: root
      mysql_root_password: password
  tasks:
      - name: Set MySQL root password
        debconf: name=mysql-server
            question=mysql-server/root_password
            value={{ mysql_root_password }}
            vtype=password

      - name: Confirm mysql root password
        debconf: name=mysql-server
            question=mysql-server/root_password_again
            value={{ mysql_root_password }}
            vtype=password

      - name: Install dependencies
        apt: name={{ item }} update_cache=yes cache_valid_time=3600
        with_items:
            - ca-certificates
            - mysql-server
            - python-mysqldb
            - unzip
            - apache2
            - php5
            - php5-mysql
            - php-pear
            - php5-gd
            - libapache2-mod-php5
            - dnsutils

      - name: Start and enable MySQL
        service: name=mysql state=started enabled=yes

      - name: Remove existing bWAPP install directory
        file: path=/var/www/html/bWAPP state=absent

      - name: Unarchive bWAPP
        unarchive:
            src: http://downloads.sourceforge.net/project/bwapp/bWAPP/bWAPP_latest.zip
            dest: /var/www/html
            remote_src: "yes"

      - name: Fix perms
        file: name=/var/www/html/bWAPP/{{ item }} mode=777
        with_items:
            - passwords/
            - images/
            - documents/
            - logs/

      - name: Config bWAPP parameters
        lineinfile:
            dest: /var/www/html/bWAPP/admin/settings.php
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            backup: "yes"
        with_items:
            - {regexp: "db_password", line: "$db_password = \"password\";"}

      - name: Configure php.ini allow_url_include
        ini_file:
            dest: /etc/php5/apache2/php.ini
            section: PHP
            option: allow_url_include
            value: "On"
        notify: Restart apache2

      - name: Configure php.ini allow_url_fopen
        ini_file:
            dest: /etc/php5/apache2/php.ini
            section: PHP
            option: allow_url_fopen
            value: "On"
        notify: Restart apache2

      - name: Configure Apache parameters
        lineinfile:
            dest: /etc/apache2/apache2.conf
            regexp: '^ServerName'
            line: 'ServerName {{ servername }}'
        notify: Restart apache2

      - name: Create bWAPP database
        mysql_db:
            name={{ mysql_db }}
            login_user={{ mysql_root_user }}
            login_password={{ mysql_root_password }}
            state=present

      - name: Copy bWAPP SQL data to import
        copy: src=bwapp/templates/bwapp.sql dest=/tmp/bwapp.sql

      - name: Insert SQL data
        mysql_db:
            name={{ mysql_db }}
            login_user={{ mysql_root_user }}
            login_password={{ mysql_root_password }}
            state=import
            target=/tmp/bwapp.sql

  handlers:
      - name: Restart apache2
        service: name=apache2 state=restarted
