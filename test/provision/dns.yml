---
- name: Configure container with bind9
  hosts: container
  become: yes
  vars:
        options_file: /etc/bind/named.conf.options
        conf_zone: /etc/bind/named.conf.local
        test_zone_weak: /var/cache/bind/db.test
        test_zone_hard: /var/cache/bind/db.test.signed
        zone_domain: fluid.la
  tasks:
        - name: Install bind9
          apt: name=bind9 update_cache=yes cache_valid_time=3600
          tags: basic

# tag: weak
# DNS inseguro
#
        - name: Copy zone
          copy: src=dns/db.test.weak dest={{ test_zone_weak }} owner=bind mode=0644
          notify: restart bind9
          tags: weak

        - name: Copy hard options config file
          template: src=dns/named.conf.options.weak owner=bind dest={{ options_file }}
          notify: restart bind9
          tags: weak

        - name: Copy weak zone config
          template: src=dns/named.conf.local.weak.j2 owner=bind dest={{ conf_zone }}
          notify: restart bind9
          tags: weak

# tag: hard
# DNS seguro
#
        - name: Copy DNSSEC files
          copy: src=dns/{{item}} dest=/var/cache/bind owner=bind mode=0600
          with_items:
                  - Kfluid.la.+007+14480.key
                  - Kfluid.la.+007+14480.private
                  - Kfluid.la.+007+26391.key
                  - Kfluid.la.+007+26391.key
          notify: restart bind9
          tags: hard

        - name: Copy zone
          copy: src=dns/db.test.signed dest={{ test_zone_hard }} owner=bind mode=0644
          notify: restart bind9
          tags: hard

        - name: Copy hard options config file
          template: src=dns/named.conf.options.hard owner=bind dest={{ options_file }}
          notify: restart bind9
          tags: hard

        - name: Copy hard zone config
          template: src=dns/named.conf.local.hard.j2 owner=bind dest={{ conf_zone }}
          notify: restart bind9
          tags: hard

  handlers:
        - name: restart bind9
          service: name=bind9 state=restarted
